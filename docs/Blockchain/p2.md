# 比特币中的密码学原理

## 术语

- crypto currency 加密货币
- cryptographic hash function 加密散列函数
- collision resistance 抗碰撞性质
- digital commitment 数字承诺
- nonce 一次性随机数值
- encryption key 密钥
- symmetric encryption algorithm 对称加密
- asymmetric encryption algorithm 非对称加密

## 哈希

cryptographic hash function 指密码学中用到的哈希函数，它有两个性质：

### Collision Resistance

collision 指哈希碰撞，即 x != y 但 H(x) = H(y)。哈希碰撞是不可避免的，因为哈希函数的输入空间远大于输出空间。比如 SHA256，输出的值固定是 256 位（输出空间 2^256），但输入可以是任意值。

有人也称这个性质称为 collision free，但不管用词是 collision resistance 还是 collision free，都不是指完全不出现哈希碰撞，而是概率极低，低到难以人为制造碰撞（只能暴力，但要求的算力极高，几乎无法实现）。

软件下载站就是利用这个性质保证文件的安全性，下载站会提前使用文件内容进行哈希并将哈希结果放在网站上，用户下载后可在本地再次哈希验证，如果结果一致代表文件在下载过程中没有损坏或被篡改。

### Hiding

hiding 指隐匿性，即 x -> H(x) 这个计算过程是单向的、不可逆的，保证了原始信息不会被哈希值泄露。这个性质要求哈希函数的输入空间够大，且输出空间的分布是较均匀的。如果输入空间很小，那么非常容易被暴力破解。如果输出空间不均匀，就零星几个值，那么也容易被总结规律，降低暴力破解的时间成本。

结合这两个性质，可以实现 digital commitment(digital equivalent of sealed envelope)。假设有一个人说自己能预测明天的股市，那么最好的验证方法就是提前一天将预测结果用信封封好交给第三方，等第二天股市收盘再拆开验证，这就是 sealed envelope。digital 的实现方法可以是将预测结果哈希后公布，hiding 性质保证了其他人无法倒推内容，collision resistance 性质保证了内容无法篡改。这里有一个问题是这两个性质要求输入空间足够大，但股市中的股票就几千只无法达到要求。对于这种情况，我们可以将数据拼接一个随机值再哈希，即 H(x||nonce)。

### Puzzle Friendly

除了密码学中用到的两个性质外，比特币还要求哈希函数具备这个性质。puzzle friendly 的哈希函数不会让你找到输入与输出值之间的联系，所有的输出值具有几乎相同的被输出的机会。即给定一个输出范围，用户没办法知道哪些输入更容易哈希出这个范围的值，只能一个一个去试。否则用户可能缩小输入的范围，进行“有根据的预测”，这样的话整个游戏过程就不够益智(puzzle)、友好（friendly）了。除了哈希过程需要 puzzle friendly 之外，验证过程也要符合，即找到这个输入值之后其他人可以轻易的验证。

## 签名

### 加密算法体系

对称加密有一个前提是通讯双方拥有安全的渠道传输加密密钥，但在网络上两个不认识的人显然是没有这种渠道的。后面出现了非对称加密，加密使用公钥，解密使用私钥。我可以公开我的公钥，任何人想要与我通信都可以使用我的公钥进行加密，我收到后再使用自己的私钥进行解密。除了加密之外，非对称加密还有一个用处就是签名。我想公布一个信息就可以用自己的私钥进行签名，公布后其他人可以使用我的公钥验签从而确定信息不是伪造的。

### 比特币中的应用

与中心化的银行开户不同，比特币的开户只需要在本地创建一对公私钥即可。公钥相当于银行卡号，私钥相当于密码。别人要转账给我只需要知道我的公钥，而拥有私钥的人就可以把我的钱转走。假设我想转比特币给别人，就可以把我的交易内容使用私钥签名后公布，其他人通过验签就可以确认这次交易是由我发起的。

如果有人想冒充我将我的比特币转走，理论上可以大量的创建公私钥，看看能不能恰好创建跟我一样的公私钥对。不过在实际中，以 256 位的哈希值来看，想要产生相同的公私钥对是不可行的，概率低到目前还没有人用这种方法成功过。要注意这里要求被创建的公私钥不相同的前提是优秀的随机源（a good source of randomness），比特币用到的签名算法不止在创建公私钥时要求好的随机源，之后的每一次签名也都需要。
